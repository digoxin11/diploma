<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>История пробок в Алматы</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
        }
        header {
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
            font-size: 1.2em;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #ecf0f1;
            padding: 10px;
        }
        #chart-container {
            width: 100%;
            height: 250px;
        }
        .slider-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<header>
    История пробок в Алматы
</header>
<div id="map"></div>
<div id="controls">
    <div class="slider-group">
        <label for="timeSlider">Выберите время:</label>
        <input type="range" id="timeSlider" min="0" max="0" step="1" value="0">
        <span id="timestamp"></span>
    </div>
    <div id="chart-container">
        <canvas id="trafficChart"></canvas>
    </div>
</div>

<script>
    const map = L.map('map').setView([43.238949, 76.889709], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OSM'
    }).addTo(map);

    let trafficData = [];
    let polylines = [];

    async function fetchSegments() {
        const res = await fetch('almaty_street_coords.json');
        return await res.json();
    }

    async function fetchTrafficData() {
        const sheetCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRW9jOKsyNq9bTevrxxpKLx-a-A7fupIyo5ygzOsoMZwABDorMUM_ymuFLruheNmjyxXawhC0wgkS6z/pub?output=csv';
        const res = await fetch(sheetCSV);
        const text = await res.text();
        const rows = text.trim().split('\n');

        const header = rows[0].split(',');
        const dataRows = rows.slice(1);

        return dataRows.map(row => {
            const values = row.split(',');
            const entry = { time: values[0], levels: {} };
            for (let i = 1; i < header.length; i++) {
                entry.levels[header[i]] = parseFloat(values[i]) || 0;
            }
            return entry;
        });
    }

    function getColor(level) {
        if (level <= 1.2) return 'green';
        if (level <= 1.5) return 'orange';
        return 'red';
    }

    async function render() {
        const segments = await fetchSegments();
        trafficData = await fetchTrafficData();

        const slider = document.getElementById('timeSlider');
        slider.max = trafficData.length - 1;
        slider.addEventListener('input', () => updateMap(slider.value));

        updateMap(0);
        drawChart();
    }

    function updateMap(index) {
        const data = trafficData[index];
        document.getElementById('timestamp').textContent = data.time;

        polylines.forEach(p => map.removeLayer(p));
        polylines = [];

        for (const [street, coords] of Object.entries(segments)) {
            coords.forEach((coord, idx) => {
                const level = data.levels[`${street}_${idx}`];
                if (typeof level !== 'undefined') {
                    const marker = L.circleMarker([coord[0], coord[1]], {
                        radius: 5,
                        color: getColor(level),
                        fillOpacity: 0.8
                    }).addTo(map);
                    marker.bindTooltip(`${street} #${idx}`, { permanent: false });
                    polylines.push(marker);
                }
            });
        }
    }

    function drawChart() {
        const ctx = document.getElementById('trafficChart').getContext('2d');
        const labels = trafficData.map(d => d.time);

        const avg = trafficData.map(d => {
            const values = Object.values(d.levels);
            return values.reduce((a, b) => a + b, 0) / values.length;
        });

        new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Средний уровень пробок',
                    data: avg,
                    borderColor: 'red',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 3 }
                }
            }
        });
    }

    render();
</script>
</body>
</html>